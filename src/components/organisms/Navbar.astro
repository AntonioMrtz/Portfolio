---
import { CONTACT_ID_TO_DATA, PERSONAL_INFO } from "@/data/me";
import { SECTIONS_ID_TO_DATA } from "@/data/sections";
import {
  Astronav,
  MenuItems,
  MenuIcon,
  OpenIcon,
  CloseIcon,
} from "astro-navbar";
import { TW_SCREEN_LG } from "@/styles/styles";
import { Image } from "astro:assets";
import hamburgerIcon from "@/assets/icons/navbar/hamburger.svg";
import closeIcon from "@/assets/icons/navbar/close.svg";

const HAMBURGER_ICON_WIDTH = 42;
const HAMBURGER_ICON_HEIGHT = 42;
---

<header id="site-navbar" class="lg:flex py-4 px-5 md:px-12 gap-5 navbar">
  <Astronav closeOnClick>
    <div class="flex w-full justify-end lg:justify-between">
      <a
        class="icon logo-icon"
        href={CONTACT_ID_TO_DATA.github.url}
        target="_blank"
        rel="noopener noreferrer"
      >
        <Image
          src={PERSONAL_INFO.logo}
          alt={`${PERSONAL_INFO.name}`}
          loading="eager"
        />
      </a>
      <div class="block lg:hidden">
        <MenuIcon class="icon navbar-text pointer cursor-pointer">
          <OpenIcon>
            <Image
              width={HAMBURGER_ICON_WIDTH}
              height={HAMBURGER_ICON_HEIGHT}
              src={hamburgerIcon}
              alt="Open menu"
              class="filter-secondary-purple-600"
              loading="eager"
            />
          </OpenIcon>
          <CloseIcon>
            <Image
              width={HAMBURGER_ICON_WIDTH}
              height={HAMBURGER_ICON_HEIGHT}
              src={closeIcon}
              alt="Close menu"
              class="filter-neutral-gray-300"
              loading="eager"
            />
          </CloseIcon>
        </MenuIcon>
      </div>
    </div>
    <MenuItems class="hidden pr-[5%] lg:flex">
      <ul class="flex flex-col gap-5 items-center lg:flex-row">
        {
          Object.values(SECTIONS_ID_TO_DATA).map((section) => (
            <li class="navbar-link">
              <a href={`#${section.id}`} class="section-link">
                <Image
                  src={section.icon}
                  alt={section.label}
                  aria-hidden="true"
                  class="nav-section-icon filter-accent-orange-500"
                  width={64}
                  height={64}
                  loading="lazy"
                />
                <p class="font-semibold text-4xl lg:text-[24px] text-neutral-gray-100 navbar-text">
                  {section.label}
                </p>
              </a>
            </li>
          ))
        }
      </ul>
    </MenuItems>
  </Astronav>
</header>

<style>
  @reference "tailwindcss";
  .navbar {
    color: var(--secondary-purple-600);
    opacity: 0.95;
    transition:
      background-color 240ms ease,
      box-shadow 240ms ease,
      border-radius 240ms ease,
      opacity 240ms ease,
      transform 240ms ease;
  }

  .navbar-text {
    transition: color 240ms ease !important;
  }

  .navbar-link:hover .navbar-text {
    color: var(--accent-orange-500) !important;
  }

  .section-link {
    display: inline-flex;
    align-items: center;
    @apply gap-6;
  }

  .nav-section-icon {
    display: inline-block;
    width: 2.5em;
    height: 2.5em;
    font-weight: bold;
    object-fit: contain;
    vertical-align: middle;
  }

  .icon {
    width: 42px;
    height: 42px;
  }

  .icon img {
    width: 100%;
    height: 100%;
    display: block;
  }

  .logo-icon {
    display: none;
  }

  .navbar.is-hidden {
    opacity: 0;
    transform: translateY(-8px);
    pointer-events: none;
  }

  :global(body.menu-open) {
    overflow: hidden;
    overscroll-behavior: none;
    touch-action: none;
  }

  @media (max-width: 1023px) {
    :global(.astronav-items) {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2.5rem 1.5rem;
      background-color: var(--secondary-purple-300);
      height: 100dvh;
      width: 100vw;
      overflow-y: auto;
    }

    :global(.astronav-items ul) {
      flex: 1;
      justify-content: center;
      align-items: start;
      gap: 1.5rem;
    }

    :global(.astronav-items .navbar-text) {
      color: var(--neutral-white);
      opacity: 1;
      line-height: 1.2;
      text-align: center;
    }

    :global(.astronav-items .navbar-link a) {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 14rem;
      padding: 0.75rem 1.5rem;
    }

    :global(.astronav-items.hidden) {
      display: none;
    }

    :global(#astronav-menu) {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      z-index: 80;
      color: var(--secondary-purple-600);
      opacity: 0.9;
    }

    :global(body.menu-open #astronav-menu) {
      color: var(--neutral-white);
      opacity: 1;
    }

    :global(body.menu-open #astronav-menu .navbar-text) {
      color: var(--neutral-white);
      opacity: 1;
    }

    :global(body.menu-open #astronav-menu .filter-neutral-gray-300) {
      filter: invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg)
        brightness(100%) contrast(100%);
    }
  }

  @media (min-width: 1024px) {
    .navbar {
      border-radius: 12px;
      margin: 12px 16px 0;
    }

    .logo-icon {
      display: block;
    }
    .icon {
      width: 48px;
      height: 48px;
    }

    .nav-section-icon {
      display: none;
    }

    .navbar-text {
      color: var(--secondary-purple-600) !important;
      opacity: 0.85 !important;
    }
  }
</style>

<script define:vars={{ lgBreakpoint: TW_SCREEN_LG }}>
  const navbar = document.getElementById("site-navbar");
  const menuItems = document.querySelector(".astronav-items");
  const menuButton = document.getElementById("astronav-menu");

  const toggleBodyScrollLock = () => {
    if (!menuItems) return;
    const isMobile = window.matchMedia(
      `(max-width: calc(${lgBreakpoint} - 1px))`,
    ).matches;
    const isMenuOpen = !menuItems.classList.contains("hidden");
    const shouldLock = isMobile && isMenuOpen;
    document.body.classList.toggle("menu-open", shouldLock);
  };

  const toggleNavbarHidden = () => {
    if (!navbar) return;
    const isDesktop = window.matchMedia(`(min-width: ${lgBreakpoint})`).matches;
    const isScrolled = window.scrollY > 100;
    if (!isDesktop) {
      navbar.classList.remove("is-hidden");
      return;
    }
    navbar.classList.toggle("is-hidden", isScrolled);
  };

  toggleNavbarHidden();
  toggleBodyScrollLock();

  window.addEventListener("scroll", toggleNavbarHidden, { passive: true });
  window.addEventListener("resize", toggleBodyScrollLock, { passive: true });
  menuButton?.addEventListener("click", () => {
    requestAnimationFrame(toggleBodyScrollLock);
  });
  if (menuItems) {
    const observer = new MutationObserver(toggleBodyScrollLock);
    observer.observe(menuItems, {
      attributes: true,
      attributeFilter: ["class"],
    });
  }
  document.addEventListener("astro:page-load", toggleBodyScrollLock);
</script>
