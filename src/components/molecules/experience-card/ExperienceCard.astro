---
import { Image } from "astro:assets";
import CardTech from "@/components/atoms/buttons/CardTech.astro";
import type { Badge } from "@/data/badges";
import { TW_SCREEN_MD } from "@/styles/styles";
import type { ImageMetadata } from "astro";

interface Props {
  imgSrc: ImageMetadata;
  imgAlt: string;
  title: string;
  subheader?: string[];
  description?: string;
  badges: Badge[];
  forceCollapseDescription?: boolean;
  forceTechColumnDisplay?: boolean;
  fixedHeight?: number;
}

const {
  imgSrc,
  imgAlt,
  title,
  subheader,
  description,
  badges,
  forceCollapseDescription = false,
  forceTechColumnDisplay = false,
  fixedHeight,
} = Astro.props;
const collapseScopeId = crypto.randomUUID();

function parseSubheaderData(subheader: string[]): string {
  return subheader.join(" | ");
}
---

<div
  class={`card-container card-reveal flex flex-col-reverse ${forceTechColumnDisplay ? "" : "lg:flex-row"} gap-12 justify-between p-4 sm:p-10 w-full m-0 rounded-xl`}
  style={fixedHeight ? `height: ${fixedHeight}px;` : undefined}
  data-collapse-scope={collapseScopeId}
>
  <div
    class={`flex flex-col ${forceTechColumnDisplay ? "" : "md:flex-row"} gap-8 min-w-0`}
  >
    <div class="flex justify-center md:justify-start w-full">
      <Image
        class="w-30 sm:w-40 h-30 sm:h-40 object-contain rounded-xl"
        src={imgSrc}
        alt={imgAlt}
        width={160}
        height={160}
        loading="lazy"
        decoding="async"
      />
    </div>
    <div class="flex flex-col gap-6 max-w-xl min-w-0">
      <div class="flex flex-col gap-2">
        <h3 class="font-bold text-lg md:text-2xl 2xl:text-3xl">{title}</h3>
        {
          subheader && (
            <h4 class="font-semibold text-md md:text-lg 2xl:text-xl">
              {parseSubheaderData(subheader)}
            </h4>
          )
        }
      </div>
      {
        description && (
          <div class="description-container">
            <p class="description whitespace-pre-line text-base 2xl:text-[1.2rem]">
              {description}
            </p>
          </div>
        )
      }
      <div class="flex flex-col md:flex-row items-center md:items-start gap-3">
        <slot name="actions" />
      </div>
    </div>
  </div>
  <div
    class={`flex flex-row ${forceTechColumnDisplay ? "" : "lg:flex-col"} flex-wrap gap-2`}
  >
    {badges.map((v) => <CardTech imageUrl={v.imageUrl} altText={v.name} />)}
  </div>
</div>

<style>
  .card-container {
    border: 1px solid var(--secondary-purple-900);
    background: var(--neutral-gray-100);
    box-shadow:
      5px 5px 0px var(--neutral-gray-500),
      -5px -5px 0px var(--neutral-white);
  }

  .card-reveal {
    opacity: 0;
    transform: translateY(60px);
    transition:
      opacity 1.2s ease-out,
      transform 1.2s ease-out;
  }

  .card-reveal.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .description-container {
    position: relative;
  }

  .description {
    transition:
      max-height 0.4s ease-in-out,
      opacity 0.3s ease-in-out;
  }

  .description-container[data-collapse="true"] {
    cursor: pointer;
  }

  .description-container[data-collapse="true"]:not(.expanded) .description {
    max-height: 8rem;
    overflow: hidden;
    position: relative;
  }

  .description-container[data-collapse="true"].expanded .description {
    max-height: 100rem;
  }

  .description-container[data-collapse="true"]:not(.expanded)
    .description::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2rem;
    background: linear-gradient(
      to bottom,
      transparent,
      var(--neutral-gray-100)
    );
    transition: opacity 0.3s ease-in-out;
  }

  .description-container[data-collapse="true"].expanded .description::after {
    opacity: 0;
  }
</style>

<script
  define:vars={{
    mdBreakpoint: TW_SCREEN_MD,
    forceCollapse: forceCollapseDescription ?? false,
    collapseScopeId,
  }}
>
  function initCardReveal() {
    const card = document.querySelector(
      `[data-collapse-scope="${collapseScopeId}"]`,
    );

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("visible");
          }
        });
      },
      {
        threshold: 0.1,
        rootMargin: "0px 0px -50px 0px",
      },
    );

    if (card) {
      observer.observe(card);
    }
  }

  function initDescriptionExpand() {
    const scope = document.querySelector(
      `[data-collapse-scope="${collapseScopeId}"]`,
    );
    const descriptionContainers = scope?.querySelectorAll(
      ".description-container",
    );

    const isMobile = window.matchMedia(`(max-width: ${mdBreakpoint})`);

    const applyCollapse = () => {
      const shouldCollapse = forceCollapse || isMobile.matches;
      descriptionContainers?.forEach((container) => {
        container.setAttribute("data-collapse", String(shouldCollapse));
        if (!shouldCollapse) {
          container.classList.remove("expanded");
        }
      });
    };

    applyCollapse();
    isMobile.addEventListener("change", applyCollapse);

    descriptionContainers?.forEach((container) => {
      container.addEventListener("click", () => {
        if (container.getAttribute("data-collapse") === "true") {
          container.classList.toggle("expanded");
        }
      });
    });
  }

  function initCard() {
    initCardReveal();
    initDescriptionExpand();
  }

  // When DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCard);
  } else {
    initCard();
  }

  // Re-run on Astro navigation
  document.addEventListener("astro:page-load", initCard);
</script>
